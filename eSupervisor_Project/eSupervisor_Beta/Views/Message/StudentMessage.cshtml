@model eSupervisor_Beta.MyClasses.SupervisorAndSecondMarkerID
@{
    ViewBag.Title = "StudentMessage";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Student Message Page</h2>

<div class="row">
    <div id="messagesTable" style=" overflow-y: scroll; overflow-x: hidden; height: 500px; width: 70%; border: 1px solid rgba(0,0,0,0.4); box-shadow: rgba(0, 0, 0, 0.3) 2px 2px 10px; padding: 30px; margin: 20px;"></div>
</div>
<div class="row" style="margin-top:30px">
    <input type="text" id="messageContent" width="400" />
    <input type="button" width="100" id="sendMessage" border="0" value="Send" />
</div>
<div class="row" style="margin-top:30px;">
    @Ajax.ActionLink("Chat with supervisor " + Model.supervisorName,
                        "GetMessages",
                        new { receiverID = Model.supervisorID },
                        new AjaxOptions
                         {
                             UpdateTargetId = "messagesTable", // <-- DOM element ID to update
                             InsertionMode = InsertionMode.Replace, // <-- Replace the content of DOM element
                             HttpMethod = "GET" // <-- HTTP method
                         },
                         new {id=Model.supervisorID})
    @Ajax.ActionLink("Chat with second marker " + Model.secondMarkerName,
                        "GetMessages",
                        new { receiverID = Model.secondMarkerID },
                        new AjaxOptions
                         {
                             UpdateTargetId = "messagesTable", // <-- DOM element ID to update
                             InsertionMode = InsertionMode.Replace, // <-- Replace the content of DOM element
                             HttpMethod = "GET" // <-- HTTP method
                         },
                         new {id=Model.secondMarkerID})
</div>
@section Scripts{
    <script src="/Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>

    <script type="text/javascript">
        var receiverID = @Model.supervisorID
        $(document).ready(function () {
            $("a").click(function () {
                receiverID = $(this).attr('id');
            });

            // Declare a proxy to reference the hub.
            var notifications = $.connection.messagesHub;

            //debugger;
            // Create a function that the hub can call to broadcast messages.
            notifications.client.updateMessages = function () {
                getAllMessages()
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                getAllMessages();
            }).fail(function (e) {
                alert(e);
            });
        });

        $("#sendMessage").click(function () {
            sendMessage();
        });

        function sendMessage() {
            var mess = $("#messageContent").val();
            $.ajax({
                type: 'POST',
                url: '/Message/SendMessage',
                data: {
                    'message': mess,
                    'receiverID': receiverID
                },
                success: function (response) {
                    if (response ==null || !response.success) {
                        window.location.reload();
                    }
                }
            });
        }

        function getAllMessages() {
            var tbl = $('#messagesTable');
            $.ajax({
                url: '/Message/GetMessages',
                data: {
                    'receiverID': receiverID
                },
                contentType: 'application/html ; charset:utf-8',
                type: 'GET',
                dataType: 'html'
            }).success(function (result) {
                tbl.empty().append(result);
                var objDiv = document.getElementById("messagesTable");
                objDiv.scrollTop = objDiv.scrollHeight;
            }).error(function () {

            });
        }
    </script>
}



